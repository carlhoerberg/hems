#!/usr/bin/env ruby
require "erb"
require_relative "../lib/devices"
require_relative "../lib/energy_management"
require_relative "../lib/http_server"
require_relative "../lib/http_server/metrics"
require_relative "../lib/http_server/relays"
require_relative "../lib/http_server/sdmo"
require_relative "../lib/http_server/button"
require_relative "../lib/http_server/topas"
require_relative "../lib/http_server/casa"
require_relative "../lib/http_server/envistar"
require_relative "../lib/http_server/em"
require_relative "../lib/http_server/eta"
require_relative "../lib/http_server/grundfos"
require_relative "../lib/http_server/shelly"
require_relative "../lib/http_server/gencomm"

$stdout.sync = true
Thread.abort_on_exception = false
devices = Devices.new
em = EnergyManagement.new(devices)
srv = HTTPServer.new({
  "/metrics" => HTTPServer::Metrics.new(devices),
  "/relays" => HTTPServer::RelaysControl.new(devices.relays),
  "/sdmo" => HTTPServer::SDMOControl.new(devices.sdmo),
  "/button1" => HTTPServer::ButtonControl.new(devices),
  "/topas" => HTTPServer::TopasControl.new(devices.topas),
  "/casa" => HTTPServer::CasaControl.new(devices.casa),
  "/envistar" => HTTPServer::EnvistarControl.new(devices.envistar),
  "/eta" => HTTPServer::ETAControl.new(devices.eta),
  "/em" => HTTPServer::EMControl.new(em),
  "/grundfos" => HTTPServer::GrundfosControl.new(devices.grundfos),
  "/shelly" => HTTPServer::ShellyControl.new(em),
  "/gencomm" => HTTPServer::GenCommControl.new(devices.gencomm),
})
trap('INT') { em.stop; srv.stop }
trap('TERM') { em.stop; srv.stop }
em_thread = Thread.new { em.start }
em_thread.abort_on_exception = true
srv.start
em_thread.wakeup if em_thread.alive?
em_thread.join
