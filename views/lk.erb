<%
# Fetch all devices in parallel
lk_data = lk_devices.map do |name, lk|
  Thread.new { [name, lk.zones, lk.actuators] }
end.map(&:value)
%>
<%lk_data.each do |name, zones, actuators|%>
# TYPE lk_zone_actual_temperature gauge
# HELP lk_zone_actual_temperature Current temperature in degrees Celsius
<%zones.each do |z|%>
lk_zone_actual_temperature{device="<%=name%>",zone="<%=z[:zone]%>",name="<%=z[:name]%>"} <%=z[:actual_temperature]%>
<%end%>

# TYPE lk_zone_actual_humidity gauge
# HELP lk_zone_actual_humidity Current humidity in percent
<%zones.each do |z|%>
lk_zone_actual_humidity{device="<%=name%>",zone="<%=z[:zone]%>",name="<%=z[:name]%>"} <%=z[:actual_humidity]%>
<%end%>

# TYPE lk_zone_target_temperature gauge
# HELP lk_zone_target_temperature Target temperature in degrees Celsius
<%zones.each do |z|%>
lk_zone_target_temperature{device="<%=name%>",zone="<%=z[:zone]%>",name="<%=z[:name]%>"} <%=z[:target_temperature]%>
<%end%>

# TYPE lk_zone_battery gauge
# HELP lk_zone_battery Thermostat battery level in percent
<%zones.each do |z|%>
lk_zone_battery{device="<%=name%>",zone="<%=z[:zone]%>",name="<%=z[:name]%>"} <%=z[:battery]%>
<%end%>

# TYPE lk_zone_signal_strength gauge
# HELP lk_zone_signal_strength Thermostat signal strength in dBm
<%zones.each do |z|%>
lk_zone_signal_strength{device="<%=name%>",zone="<%=z[:zone]%>",name="<%=z[:name]%>"} <%=z[:signal_strength]%>
<%end%>

# TYPE lk_actuator_status gauge
# HELP lk_actuator_status Actuator status (0=off, 1=on, 2=unknown)
<%actuators.each do |a|%>
lk_actuator_status{device="<%=name%>",actuator="<%=a[:actuator]%>",name="<%=a[:name]%>"} <%=a[:status]%>
<%end%>

<%end%>
# TYPE metrics_gather_time gauge
metrics_gather_time{device="lk"} <%=Process.clock_gettime(Process::CLOCK_MONOTONIC) - t%>
